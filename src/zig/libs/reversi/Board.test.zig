// std import
const std = @import("std");
const builtin = @import("builtin");

// common import
const common = @import("../common/main.zig");
const BitBoard = common.bit_board.BitBoard(8, 8);

// internal import
const Board = @import("./Board.zig");

test "ğŸ“–Board.moveMutate: é»’ã‚’å‹•ã‹ã™" {
    var board = Board.fromString(
        \\o..o..o.
        \\.x.x.x..
        \\..xxx...
        \\oxx.xxxo
        \\..xxx...
        \\.x.x.x..
        \\o..x..x.
        \\...o...o
    );

    const place = BitBoard.fromString(
        \\........
        \\........
        \\........
        \\...o....
        \\........
        \\........
        \\........
        \\........
    , 'o');

    const expected = Board.fromString(
        \\o..o..o.
        \\.o.o.o..
        \\..ooo...
        \\oooooooo
        \\..ooo...
        \\.o.o.o..
        \\o..o..o.
        \\...o...o
    );

    board.moveMutate(place);

    try std.testing.expectEqualDeep(expected, board);
}

test "get valid move" {
    // ç¾åœ¨ã®ãƒœãƒ¼ãƒ‰çŠ¶æ…‹
    const board = Board.fromString(
        \\...x..x.
        \\.x.x.x..
        \\..xxx...
        \\.xxoxxxx
        \\...x....
        \\.x.x.x..
        \\.xxxxxxo
        \\........
    );

    // ãƒã‚¹ã‚¯
    // ç›¸æ‰‹ã®çŸ³ãŒã‚ã‚‹ã¨ã“ã‚ã ã‘ + ç«¯ã‚’ãƒ«ãƒ¼ãƒ—ã—ãªã„ã‚ˆã†ã«æ­¢ã‚ã‚‹
    const mask = board.boards.get(.white).masks(BitBoard.west_mask.masks(BitBoard.east_mask));

    try mask.expect(
        \\...o..o.
        \\.o.o.o..
        \\..ooo...
        \\.oo.ooo.
        \\...o....
        \\.o.o.o..
        \\.oooooo.
        \\........
    );

    var flip = board.boards.get(.black);
    const dir = 1;

    try flip.expect(
        \\........
        \\........
        \\........
        \\...o....
        \\........
        \\........
        \\.......o
        \\........
    );

    // dirã§æ±ºã‚ã‚‰ã‚ŒãŸæ–¹å‘ã«å‘ã‘ã¦çŸ³ã‚’ç½®ã
    // æ­£ã®æ–¹å‘ã¨è² ã®æ–¹å‘ã®2æ–¹å‘ã‚’åŒæ™‚ã«é€²ã‚ã‚‹
    flip = flip.shl(dir).unions(flip.shr(dir)).masks(mask);

    try flip.expect(
        \\........
        \\........
        \\........
        \\..o.o...
        \\........
        \\........
        \\......o.
        \\........
    );

    // ã•ã‚‰ã«é€²ã‚ãŸã‚‚ã®ã‚’å‰å›ã®ã‚‚ã®ã¨ORã§é‡ã­ã‚‹
    flip.setUnion(flip.shl(dir).unions(flip.shr(dir)).masks(mask));

    try flip.expect(
        \\........
        \\........
        \\........
        \\.oo.oo..
        \\........
        \\........
        \\.....oo.
        \\........
    );

    // åˆè¨ˆã§6å›é€²ã‚ã‚‹
    flip.setUnion(flip.shl(dir).unions(flip.shr(dir)).masks(mask));
    flip.setUnion(flip.shl(dir).unions(flip.shr(dir)).masks(mask));
    flip.setUnion(flip.shl(dir).unions(flip.shr(dir)).masks(mask));
    flip.setUnion(flip.shl(dir).unions(flip.shr(dir)).masks(mask));

    try flip.expect(
        \\........
        \\........
        \\........
        \\.oo.ooo.
        \\........
        \\........
        \\.oooooo.
        \\........
    );

    // æœ€å¾Œã«ãƒã‚¹ã‚¯ãªã—ã§é€²ã‚ã‚‹
    // è‡ªåˆ†ã®çŸ³ã®éš£ã«ç›¸æ‰‹ã®çŸ³ãŒç¹‹ãŒã£ã¦ã„ã‚‹ã‚‚ã®ã®ä¸€ç•ªå…ˆé ­

    flip = flip.shl(dir).unions(flip.shr(dir));

    try flip.expect(
        \\........
        \\........
        \\........
        \\oooooooo
        \\........
        \\........
        \\oooooooo
        \\........
    );

    // ã“ã‚Œã‚’ã€ŒçŸ³ãŒç½®ã‹ã‚Œã¦ã„ãªã„å ´æ‰€ã€ã§ãƒã‚¹ã‚¯
    flip = flip.excludes(board.boards.get(.black).unions(board.boards.get(.white)));

    try flip.expect(
        \\........
        \\........
        \\........
        \\o.......
        \\........
        \\........
        \\o.......
        \\........
    );

    // ã“ã‚Œã‚’ç¸¦æ¨ªæ–œã‚ã®4æ–¹å‘ã«å‘ã‘ã‚‹
    try board.getValidMoves().expect(
        \\o.......
        \\........
        \\........
        \\o.......
        \\........
        \\........
        \\o.......
        \\...o....
    );
}

test "get valid move 1" {
    const board = Board.fromString(
        \\.ox.....
        \\........
        \\........
        \\.oxxx...
        \\........
        \\......ox
        \\........
        \\oxxxxxx.
    );

    try board.getValidMoves().expect(
        \\...o....
        \\........
        \\........
        \\.....o..
        \\........
        \\........
        \\........
        \\.......o
    );
}

test "get valid move 2" {
    const board = Board.fromString(
        \\.o...x..
        \\.x.o.o.x
        \\...x...x
        \\...x...x
        \\...x...x
        \\o......x
        \\.......x
        \\.......o
    );

    try board.getValidMoves().expect(
        \\.......o
        \\........
        \\.o......
        \\........
        \\........
        \\...o....
        \\........
        \\........
    );
}

test "get valid move 3" {
    const board = Board.fromString(
        \\o.......
        \\.x...o..
        \\..x...x.
        \\...x....
        \\....x...
        \\.x...x..
        \\..x...x.
        \\o..o....
    );

    try board.getValidMoves().expect(
        \\........
        \\........
        \\........
        \\.......o
        \\o.......
        \\........
        \\........
        \\.......o
    );
}

test "get valid move 4" {
    const board = Board.fromString(
        \\..x.....
        \\.x....x.
        \\o....x..
        \\....x..o
        \\...x..x.
        \\..x..x..
        \\.x..x...
        \\o.......
    );

    try board.getValidMoves().expect(
        \\.......o
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\...o....
    );
}

test "game is end" {
    const board = Board.fromString(
        \\oooooooo
        \\xxxxxxxx
        \\oooooooo
        \\xxxxxxxx
        \\oooooooo
        \\xxxxxxxx
        \\oooooooo
        \\xxxxxxxx
    );

    try std.testing.expect(board.isEnd());
}

test "game is not end" {
    const board = Board.fromString(
        \\oooooooo
        \\xxxxxxxx
        \\oooooooo
        \\xxxxxxxx
        \\ooo.oooo
        \\xxxxxxxx
        \\oooooooo
        \\xxxxxxxx
    );

    try std.testing.expect(!board.isEnd());
}

test "board from string" {
    const expected = Board{
        .boards = Board.ColorBoards.init(.{
            .black = BitBoard.fromInteger(0x00_00_00_00_00_aa_55_aa),
            .white = BitBoard.fromInteger(0x55_aa_55_00_00_00_00_00),
        }),
    };

    const actual = Board.fromString(
        \\.o.o.o.o
        \\o.o.o.o.
        \\.o.o.o.o
        \\........
        \\........
        \\x.x.x.x.
        \\.x.x.x.x
        \\x.x.x.x.
    );

    try std.testing.expectEqualDeep(expected, actual);
}
