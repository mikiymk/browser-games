// std import
const std = @import("std");
const builtin = @import("builtin");

// common import
const common = @import("../common/main.zig");
const BitBoard = common.bit_board.BitBoard(8, 8);

// internal import
const main = @import("./main.zig");
const Board = main.Board;
const moves = main.moves;

test "ğŸ“–Board.initWithString: æ–‡å­—åˆ—ã‹ã‚‰ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã™ã‚‹" {
    const board = Board.initWithString(
        \\RNBQKBNR
        \\PPPPPPPP
        \\........
        \\........
        \\........
        \\........
        \\pppppppp
        \\rnbqkbnr
    );

    try board.getBoard(.black, .pawn).expect(
        \\........
        \\oooooooo
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );

    try board.getBoard(.white, .rook).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\o......o
    );
}

test "ğŸ“–Board.filterValidMove: æœ‰åŠ¹ãªå‹•ãã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹" {
    const board_str =
        \\........
        \\...R....
        \\........
        \\........
        \\........
        \\........
        \\...r....
        \\...k....
    ;
    const board = Board.initWithString(board_str);
    const from = BitBoard.initWithString(board_str, 'r');
    const to = moves.rook(board, from, .white);

    const actual = board.filterValidMove(from, to);

    try actual.expect(
        \\........
        \\...o....
        \\...o....
        \\...o....
        \\...o....
        \\...o....
        \\........
        \\........
    );
}

test "ğŸ“–Board.canCastling: ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ãŒã§ãã‚‹ã‹åˆ¤å®šã™ã‚‹" {
    const board = Board.initWithString(
        \\R...K..R
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\r...k..r
    );

    try std.testing.expect(board.canCastling(.black_king));
    try std.testing.expect(board.canCastling(.black_queen));
    try std.testing.expect(board.canCastling(.white_king));
    try std.testing.expect(board.canCastling(.white_queen));
}

test "ğŸ“–Board.canCastling: ã‚­ãƒ³ã‚°ãŒæ”»æ’ƒã•ã‚Œã¦ã„ã‚‹" {
    const board = Board.initWithString(
        \\....K..R
        \\........
        \\........
        \\........
        \\....r...
        \\........
        \\........
        \\........
    );

    try std.testing.expect(!board.canCastling(.black_king));
}

test "ğŸ“–Board.canCastling: é§’ãŒå‹•ã„ãŸ" {
    var board = Board.initWithString(
        \\R...K...
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\....k..r
    );

    board = board.getMovedBoard(BitBoard.initWithCoordinate(4, 7), BitBoard.initWithCoordinate(4, 6));
    board = board.getMovedBoard(BitBoard.initWithCoordinate(7, 0), BitBoard.initWithCoordinate(7, 2));

    try std.testing.expect(!board.canCastling(.black_queen));
    try std.testing.expect(!board.canCastling(.white_king));
}

test "ğŸ“–Board.canCastling: ä»–ã®é§’ãŒé–“ã«ã‚ã‚‹" {
    const board = Board.initWithString(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\rn..k...
    );

    try std.testing.expect(!board.canCastling(.white_queen));
}

test "ğŸ“–Board.isChecked: ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹" {
    const board = Board.initWithString(
        \\........
        \\.....R..
        \\........
        \\.K......
        \\.....k..
        \\........
        \\.q......
        \\........
    );

    try std.testing.expect(board.isChecked(.black));
    try std.testing.expect(board.isChecked(.white));
}

test "ğŸ“–Board.isChecked: ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„" {
    const board = Board.initWithString(
        \\........
        \\......B.
        \\........
        \\...K....
        \\........
        \\........
        \\..q...k.
        \\........
    );

    try std.testing.expect(!board.isChecked(.black));
    try std.testing.expect(!board.isChecked(.white));
}

test "ğŸ“–Board.canMove: å‹•ã‘ã‚‹ã‹ã©ã†ã‹" {
    {
        const board = Board.initWithString(
            \\....K...
            \\........
            \\..b..q..
            \\........
            \\........
            \\........
            \\........
            \\........
        );

        try std.testing.expect(!board.canMove(.black));
    }

    {
        const board = Board.initWithString(
            \\....K...
            \\.r......
            \\.....n..
            \\........
            \\........
            \\........
            \\........
            \\........
        );

        try std.testing.expect(board.canMove(.black));
    }
}

test "ğŸ“–Board.getMove: å‹•ã‘ã‚‹å ´æ‰€ã‚’è¨ˆç®—ã™ã‚‹" {
    const board = Board.initWithString(
        \\........
        \\........
        \\........
        \\........
        \\...r....
        \\........
        \\........
        \\........
    );

    try board.getMove(BitBoard.initWithCoordinate(3, 3)).expect(
        \\...o....
        \\...o....
        \\...o....
        \\...o....
        \\ooo.oooo
        \\...o....
        \\...o....
        \\...o....
    );
}

test "ğŸ“–Board.getMove: ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°" {
    const board = Board.initWithString(
        \\R...K..R
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );

    try board.getMove(BitBoard.initWithCoordinate(4, 7)).expect(
        \\o..o.o.o
        \\...ooo..
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );
}

test "ğŸ“–Board.getMove: ã‚¢ãƒ³ãƒ‘ãƒƒã‚µãƒ³" {
    var board = Board.initWithString(
        \\........
        \\........
        \\........
        \\........
        \\...pPp..
        \\........
        \\........
        \\........
    );
    board.enpassant_target = BitBoard.initWithCoordinate(5, 2);

    try board.getMove(BitBoard.initWithCoordinate(4, 3)).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\....oo..
        \\........
        \\........
    );
}

test "ğŸ“–Board.isPromotion: ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹å‹•ãã‹åˆ¤å®šã™ã‚‹" {
    const board = Board.initWithString(
        \\........
        \\.r..P...
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );

    try std.testing.expect(board.isPromotion(BitBoard.initWithCoordinate(4, 6), BitBoard.initWithCoordinate(4, 7)));
    try std.testing.expect(!board.isPromotion(BitBoard.initWithCoordinate(1, 6), BitBoard.initWithCoordinate(1, 7)));
}

test "ğŸ“–Board.getMovedBoard: å‹•ã" {
    const board = Board.init();

    const actual = board.getMovedBoard(
        BitBoard.initWithCoordinate(4, 1),
        BitBoard.initWithCoordinate(4, 3),
    );

    try actual.getBoard(.white, .pawn).expect(
        \\........
        \\........
        \\........
        \\........
        \\....o...
        \\........
        \\oooo.ooo
        \\........
    );

    try actual.getBoard(.white, .rook).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\o......o
    );
}

test "ğŸ“–Board.getMovedBoard: ã‚­ãƒ£ãƒ—ãƒãƒ£" {
    const board = Board.initWithString(
        \\........
        \\..PP....
        \\....p...
        \\........
        \\........
        \\........
        \\pppp.ppp
        \\rnbqkbnr
    );

    const actual = board.getMovedBoard(
        BitBoard.initWithCoordinate(4, 5),
        BitBoard.initWithCoordinate(3, 6),
    );

    try actual.getBoard(.white, .pawn).expect(
        \\........
        \\...o....
        \\........
        \\........
        \\........
        \\........
        \\oooo.ooo
        \\........
    );

    try actual.getBoard(.black, .pawn).expect(
        \\........
        \\..o.....
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );
}

test "ğŸ“–Board.getMovedBoard: ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°" {
    const board = Board.initWithString(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\pppp.ppp
        \\r...k...
    );

    const actual = board.getMovedBoard(
        BitBoard.initWithCoordinate(4, 0),
        BitBoard.initWithCoordinate(0, 0),
    );

    try actual.getBoard(.white, .rook).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\...o....
    );

    try actual.getBoard(.white, .king).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\..o.....
    );
}

test "ğŸ“–Board.getMovedBoard: ã‚¢ãƒ³ãƒ‘ãƒƒã‚µãƒ³" {
    const board = Board.initWithString(
        \\........
        \\........
        \\........
        \\....pPP.
        \\........
        \\........
        \\pppp.ppp
        \\r...k...
    );

    const actual = board.getMovedBoard(
        BitBoard.initWithCoordinate(4, 4),
        BitBoard.initWithCoordinate(5, 5),
    );

    try actual.getBoard(.white, .pawn).expect(
        \\........
        \\........
        \\.....o..
        \\........
        \\........
        \\........
        \\oooo.ooo
        \\........
    );

    try actual.getBoard(.black, .pawn).expect(
        \\........
        \\........
        \\........
        \\......o.
        \\........
        \\........
        \\........
        \\........
    );
}

test "ğŸ“–Board.getMovedBoard: é§’ãŒå‹•ãã¨ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ãŒã§ããªããªã‚‹" {
    var board = Board.initWithString(
        \\R...K..R
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\r...k..r
    );

    try std.testing.expect(board.castling_available.white_queen);
    try std.testing.expect(board.castling_available.white_king);

    board = board.getMovedBoard(BitBoard.initWithCoordinate(0, 0), BitBoard.initWithCoordinate(0, 3));

    try std.testing.expect(!board.castling_available.white_queen);
    try std.testing.expect(board.castling_available.white_king);

    board = board.getMovedBoard(BitBoard.initWithCoordinate(4, 0), BitBoard.initWithCoordinate(4, 3));

    try std.testing.expect(!board.castling_available.white_queen);
    try std.testing.expect(!board.castling_available.white_king);

    try std.testing.expect(board.castling_available.black_queen);
    try std.testing.expect(board.castling_available.black_king);

    board = board.getMovedBoard(BitBoard.initWithCoordinate(4, 7), BitBoard.initWithCoordinate(7, 7));

    try std.testing.expect(!board.castling_available.black_queen);
    try std.testing.expect(!board.castling_available.black_king);
}

test "ğŸ“–Board.getMovedBoard: ãƒãƒ¼ãƒ³ãŒ2å€‹é€²ã‚€ã¨ã‚¢ãƒ³ãƒ‘ãƒƒã‚µãƒ³å¯¾è±¡ã«ãªã‚‹" {
    var board = Board.initWithString(
        \\........
        \\...P....
        \\........
        \\..p.....
        \\.....P..
        \\........
        \\....p...
        \\........
    );

    board = board.getMovedBoard(BitBoard.initWithCoordinate(4, 1), BitBoard.initWithCoordinate(4, 3));

    try std.testing.expectEqual(board.enpassant_target, BitBoard.initWithCoordinate(4, 2));

    board = board.getMovedBoard(BitBoard.initWithCoordinate(3, 6), BitBoard.initWithCoordinate(3, 4));

    try std.testing.expectEqual(board.enpassant_target, BitBoard.initWithCoordinate(3, 5));
}

test "ğŸ“–Board.getPromotionBoard: ãƒãƒ¼ãƒ³ãŒãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹" {
    var board = Board.initWithString(
        \\....p...
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\....P...
    );

    board = board.getPromotionBoard(BitBoard.initWithCoordinate(4, 7), .knight);
    board = board.getPromotionBoard(BitBoard.initWithCoordinate(4, 0), .queen);

    try board.getBoard(.white, .pawn).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );
    try board.getBoard(.white, .knight).expect(
        \\....o...
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );

    try board.getBoard(.black, .pawn).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
    );
    try board.getBoard(.black, .queen).expect(
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\........
        \\....o...
    );
}
